<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>QR Code Generator</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/trading/assets/css/styles.css">
    <!-- Global App Config -->
    <script src="/trading/assets/js/config.js"></script>
    <style>
        .qr-code-container {
            min-height: 300px;
            border: 2px dashed var(--bs-border-color);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bs-secondary-bg);
            transition: all 0.3s ease;
        }
        
        .qr-code-container.has-code {
            border-style: solid;
            background-color: white;
            padding: 20px;
        }
        
        .qr-placeholder {
            text-align: center;
            color: var(--bs-secondary-color);
        }
        
        .form-control.monospace {
            font-family: var(--bs-font-monospace);
        }
        
        .qr-type-card {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .qr-type-card:hover {
            border-color: var(--bs-primary);
            transform: translateY(-2px);
        }
        
        .qr-type-card.active {
            border-color: var(--bs-primary);
            background-color: var(--bs-primary-bg-subtle);
        }
        
        .qr-options {
            background-color: var(--bs-secondary-bg);
            border-radius: 0.375rem;
            padding: 1rem;
        }
        
        .download-options {
            display: none;
        }
        
        .download-options.show {
            display: block;
        }
        
        #qr-code-display {
            text-align: center;
        }
        
        .error-correction-info {
            font-size: 0.875rem;
            color: var(--bs-secondary-color);
        }
    </style>
</head>
<body class="qr-code-generator-page d-flex flex-column vh-100">
    <div id="header-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="flex-grow-1">
        <div class="container py-4">
            <h1 class="mb-2 text-center">QR Code Generator</h1>
            <p class="text-center text-muted mb-4">Generate QR codes for various data types with customizable options.</p>

            <!-- QR Code Types Selection -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <h5 class="mb-3">Select QR Code Type</h5>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100 active" data-type="text">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">text_fields</span>
                            <small class="fw-bold">Text</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="url">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">link</span>
                            <small class="fw-bold">URL</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="email">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">email</span>
                            <small class="fw-bold">Email</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="phone">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">phone</span>
                            <small class="fw-bold">Phone</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="sms">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">sms</span>
                            <small class="fw-bold">SMS</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="vcard">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">contact_page</span>
                            <small class="fw-bold">vCard</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="wifi">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">wifi</span>
                            <small class="fw-bold">WiFi</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="location">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">location_on</span>
                            <small class="fw-bold">Location</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="card qr-type-card h-100" data-type="event">
                        <div class="card-body text-center p-2">
                            <span class="material-symbols-outlined d-block mb-1" style="font-size: 2rem;">event</span>
                            <small class="fw-bold">Event</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Input Section -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Content</h5>
                        </div>
                        <div class="card-body">
                            <!-- Dynamic form content will be inserted here -->
                            <div id="qr-form-container">
                                <!-- Text input form (default) -->
                                <div id="form-text" class="qr-form">
                                    <div class="mb-3">
                                        <label for="text-content" class="form-label">Text Content</label>
                                        <textarea class="form-control" id="text-content" rows="4" placeholder="Enter your text here..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- QR Code Options -->
                            <div class="qr-options mt-4">
                                <h6 class="mb-3">QR Code Options</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="qr-size" class="form-label">Size (pixels)</label>
                                        <select class="form-select" id="qr-size">
                                            <option value="128">128x128 - Small icons/thumbnails</option>
                                            <option value="200">200x200 - Small web use</option>
                                            <option value="256">256x256 - Standard web icons</option>
                                            <option value="300" selected>300x300 - Balanced quality/size</option>
                                            <option value="400">400x400 - Medium web/print</option>
                                            <option value="500">500x500 - Large web display</option>
                                            <option value="512">512x512 - Power of 2 dimension</option>
                                            <option value="600">600x600 - Large print quality</option>
                                            <option value="700">700x700 - Extra large display</option>
                                            <option value="800">800x800 - High resolution web</option>
                                            <option value="1000">1000x1000 - High quality print</option>
                                            <option value="1024">1024x1024 - Standard high-res</option>
                                            <option value="1200">1200x1200 - Professional print</option>
                                            <option value="1500">1500x1500 - Large format print</option>
                                            <option value="2000">2000x2000 - Maximum quality print</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="error-correction" class="form-label">Error Correction</label>
                                        <select class="form-select" id="error-correction">
                                            <option value="L">Low (~7%)</option>
                                            <option value="M" selected>Medium (~15%)</option>
                                            <option value="Q">Quartile (~25%)</option>
                                            <option value="H">High (~30%)</option>
                                        </select>
                                        <div class="error-correction-info mt-1">
                                            Higher levels allow more damage recovery
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="button" id="generate-btn" class="btn btn-primary btn-lg">
                                    <span class="material-symbols-outlined icon-inline">qr_code</span>
                                    Generate QR Code
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Code Display Section -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">QR Code</h5>
                            <div class="download-options">
                                <button id="download-png-btn" class="btn btn-sm btn-outline-primary me-2">
                                    <span class="material-symbols-outlined icon-inline-sm">download</span>
                                    PNG
                                </button>
                                <button id="download-svg-btn" class="btn btn-sm btn-outline-primary">
                                    <span class="material-symbols-outlined icon-inline-sm">download</span>
                                    SVG
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="qr-code-container" id="qr-code-container">
                                <div class="qr-placeholder" id="qr-placeholder">
                                    <span class="material-symbols-outlined d-block mb-2" style="font-size: 3rem;">qr_code</span>
                                    <p class="mb-0">Your QR code will appear here</p>
                                </div>
                                <div id="qr-code-display"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="button" id="reset-btn" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined icon-inline">refresh</span>
                    Reset
                </button>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- jQuery 3.7.1 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- QRious Library (alternative QR code generator) -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <!-- Shared Header Script -->
    <script src="/trading/assets/js/header.js"></script>

    <script>
        $(document).ready(function() {
            // Debug logging function that checks global debug mode
            function debugLog(...args) {
                const debugSwitch = $('#enable-debug-mode-switch');
                if (debugSwitch.length && debugSwitch.is(':checked')) {
                    console.log(...args);
                }
            }

            // --- Load Shared Components ---
            $("#header-placeholder").load("/trading/assets/includes/_header.html", () => initializeHeader && initializeHeader());
            $("#navbar-placeholder").load("/trading/assets/includes/_navbar.html");
            $("#footer-placeholder").load("/trading/assets/includes/_footer.html");

            // --- Constants and Selectors ---
            const STORAGE_KEY = 'qrCodeGeneratorState';
            let currentQRType = 'text';
            let currentQRData = '';

            // --- QR Code Type Forms ---
            const qrForms = {
                text: `
                    <div id="form-text" class="qr-form">
                        <div class="mb-3">
                            <label for="text-content" class="form-label">Text Content</label>
                            <textarea class="form-control" id="text-content" rows="4" placeholder="Enter your text here...">Hello, World!</textarea>
                        </div>
                    </div>
                `,
                url: `
                    <div id="form-url" class="qr-form">
                        <div class="mb-3">
                            <label for="url-address" class="form-label">Website URL</label>
                            <input type="url" class="form-control" id="url-address" placeholder="https://example.com">
                        </div>
                    </div>
                `,
                email: `
                    <div id="form-email" class="qr-form">
                        <div class="mb-3">
                            <label for="email-to" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email-to" placeholder="someone@example.com">
                        </div>
                        <div class="mb-3">
                            <label for="email-subject" class="form-label">Subject (optional)</label>
                            <input type="text" class="form-control" id="email-subject" placeholder="Email subject">
                        </div>
                        <div class="mb-3">
                            <label for="email-body" class="form-label">Message (optional)</label>
                            <textarea class="form-control" id="email-body" rows="3" placeholder="Email message"></textarea>
                        </div>
                    </div>
                `,
                phone: `
                    <div id="form-phone" class="qr-form">
                        <div class="mb-3">
                            <label for="phone-number" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone-number" placeholder="+1234567890">
                            <div class="form-text">Include country code (e.g., +1 for US)</div>
                        </div>
                    </div>
                `,
                sms: `
                    <div id="form-sms" class="qr-form">
                        <div class="mb-3">
                            <label for="sms-number" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="sms-number" placeholder="+1234567890">
                        </div>
                        <div class="mb-3">
                            <label for="sms-message" class="form-label">Message (optional)</label>
                            <textarea class="form-control" id="sms-message" rows="3" placeholder="SMS message"></textarea>
                        </div>
                    </div>
                `,
                vcard: `
                    <div id="form-vcard" class="qr-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="vcard-firstname" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="vcard-firstname" placeholder="John">
                            </div>
                            <div class="col-md-6">
                                <label for="vcard-lastname" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="vcard-lastname" placeholder="Doe">
                            </div>
                            <div class="col-md-6">
                                <label for="vcard-phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="vcard-phone" placeholder="+1234567890">
                            </div>
                            <div class="col-md-6">
                                <label for="vcard-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="vcard-email" placeholder="john@example.com">
                            </div>
                            <div class="col-12">
                                <label for="vcard-organization" class="form-label">Organization (optional)</label>
                                <input type="text" class="form-control" id="vcard-organization" placeholder="Company Name">
                            </div>
                            <div class="col-12">
                                <label for="vcard-url" class="form-label">Website (optional)</label>
                                <input type="url" class="form-control" id="vcard-url" placeholder="https://example.com">
                            </div>
                        </div>
                    </div>
                `,
                wifi: `
                    <div id="form-wifi" class="qr-form">
                        <div class="mb-3">
                            <label for="wifi-ssid" class="form-label">Network Name (SSID)</label>
                            <input type="text" class="form-control" id="wifi-ssid" placeholder="MyWiFiNetwork">
                        </div>
                        <div class="mb-3">
                            <label for="wifi-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="wifi-password" placeholder="WiFi password">
                        </div>
                        <div class="mb-3">
                            <label for="wifi-security" class="form-label">Security Type</label>
                            <select class="form-select" id="wifi-security">
                                <option value="WPA">WPA/WPA2</option>
                                <option value="WEP">WEP</option>
                                <option value="nopass">Open (No Password)</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="wifi-hidden">
                            <label class="form-check-label" for="wifi-hidden">
                                Hidden Network
                            </label>
                        </div>
                    </div>
                `,
                location: `
                    <div id="form-location" class="qr-form">
                        <div class="mb-3">
                            <label for="location-lat" class="form-label">Latitude</label>
                            <input type="number" class="form-control" id="location-lat" step="any" placeholder="40.7128">
                        </div>
                        <div class="mb-3">
                            <label for="location-lng" class="form-label">Longitude</label>
                            <input type="number" class="form-control" id="location-lng" step="any" placeholder="-74.0060">
                        </div>
                        <div class="mb-3">
                            <label for="location-name" class="form-label">Location Name (optional)</label>
                            <input type="text" class="form-control" id="location-name" placeholder="New York City">
                        </div>
                    </div>
                `,
                event: `
                    <div id="form-event" class="qr-form">
                        <div class="mb-3">
                            <label for="event-title" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="event-title" placeholder="Birthday Party">
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="event-start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="event-start-date">
                            </div>
                            <div class="col-md-6">
                                <label for="event-start-time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="event-start-time">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="event-end-date" class="form-label">End Date (optional)</label>
                                <input type="date" class="form-control" id="event-end-date">
                            </div>
                            <div class="col-md-6">
                                <label for="event-end-time" class="form-label">End Time (optional)</label>
                                <input type="time" class="form-control" id="event-end-time">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="event-location" class="form-label">Location (optional)</label>
                            <input type="text" class="form-control" id="event-location" placeholder="123 Main St, City">
                        </div>
                        <div class="mb-3">
                            <label for="event-description" class="form-label">Description (optional)</label>
                            <textarea class="form-control" id="event-description" rows="3" placeholder="Event description"></textarea>
                        </div>
                    </div>
                `
            };

            // --- QR Code Data Builders ---
            function buildQRData(type) {
                debugLog('Building QR data for type:', type);
                
                let result = '';
                
                switch (type) {
                    case 'text':
                        result = $('#text-content').val().trim();
                        break;
                    
                    case 'url':
                        const url = $('#url-address').val().trim();
                        result = url && !url.startsWith('http') ? 'https://' + url : url;
                        break;
                    
                    case 'email':
                        const email = $('#email-to').val().trim();
                        const subject = $('#email-subject').val().trim();
                        const body = $('#email-body').val().trim();
                        let mailto = `mailto:${email}`;
                        const params = [];
                        if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
                        if (body) params.push(`body=${encodeURIComponent(body)}`);
                        if (params.length > 0) mailto += '?' + params.join('&');
                        result = mailto;
                        break;
                    
                    case 'phone':
                        result = `tel:${$('#phone-number').val().trim()}`;
                        break;
                    
                    case 'sms':
                        const smsNumber = $('#sms-number').val().trim();
                        const smsMessage = $('#sms-message').val().trim();
                        result = smsMessage ? `sms:${smsNumber}?body=${encodeURIComponent(smsMessage)}` : `sms:${smsNumber}`;
                        break;
                    
                    case 'vcard':
                        const firstName = $('#vcard-firstname').val().trim();
                        const lastName = $('#vcard-lastname').val().trim();
                        const phone = $('#vcard-phone').val().trim();
                        const vcardEmail = $('#vcard-email').val().trim();
                        const org = $('#vcard-organization').val().trim();
                        const vcardUrl = $('#vcard-url').val().trim();
                        
                        let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
                        if (firstName || lastName) vcard += `FN:${firstName} ${lastName}\n`;
                        if (firstName || lastName) vcard += `N:${lastName};${firstName};;;\n`;
                        if (phone) vcard += `TEL:${phone}\n`;
                        if (vcardEmail) vcard += `EMAIL:${vcardEmail}\n`;
                        if (org) vcard += `ORG:${org}\n`;
                        if (vcardUrl) vcard += `URL:${vcardUrl}\n`;
                        vcard += 'END:VCARD';
                        result = vcard;
                        break;
                    
                    case 'wifi':
                        const ssid = $('#wifi-ssid').val().trim();
                        const password = $('#wifi-password').val().trim();
                        const security = $('#wifi-security').val();
                        const hidden = $('#wifi-hidden').is(':checked');
                        result = `WIFI:T:${security};S:${ssid};P:${password};H:${hidden ? 'true' : 'false'};;`;
                        break;
                    
                    case 'location':
                        const lat = $('#location-lat').val().trim();
                        const lng = $('#location-lng').val().trim();
                        const locationName = $('#location-name').val().trim();
                        if (lat && lng) {
                            result = locationName ? 
                                `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(locationName)})` :
                                `geo:${lat},${lng}`;
                        }
                        break;
                    
                    case 'event':
                        const title = $('#event-title').val().trim();
                        const startDate = $('#event-start-date').val();
                        const startTime = $('#event-start-time').val();
                        const endDate = $('#event-end-date').val();
                        const endTime = $('#event-end-time').val();
                        const eventLocation = $('#event-location').val().trim();
                        const description = $('#event-description').val().trim();
                        
                        if (!title || !startDate) {
                            result = '';
                            break;
                        }
                        
                        const formatDateTime = (date, time) => {
                            const dt = new Date(date + (time ? 'T' + time : 'T00:00:00'));
                            return dt.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                        };
                        
                        let ical = 'BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\n';
                        ical += `SUMMARY:${title}\n`;
                        ical += `DTSTART:${formatDateTime(startDate, startTime)}\n`;
                        if (endDate) {
                            ical += `DTEND:${formatDateTime(endDate, endTime)}\n`;
                        }
                        if (eventLocation) ical += `LOCATION:${eventLocation}\n`;
                        if (description) ical += `DESCRIPTION:${description}\n`;
                        ical += 'END:VEVENT\nEND:VCALENDAR';
                        result = ical;
                        break;
                    
                    default:
                        result = '';
                }
                
                debugLog('Built QR data:', result);
                return result;
            }

            // --- QR Code Generation ---
            function generateQRCode() {
                const data = buildQRData(currentQRType);
                
                if (!data) {
                    alert('Please fill in the required fields.');
                    return;
                }

                currentQRData = data;
                debugLog('Generating QR code with data:', data);

                const size = parseInt($('#qr-size').val());
                const errorCorrectionLevel = $('#error-correction').val();

                const $container = $('#qr-code-container');
                const $display = $('#qr-code-display');
                const $placeholder = $('#qr-placeholder');

                // Clear previous QR code
                $display.empty();
                $container.removeClass('has-code');
                $placeholder.show();

                // Check if QRious library is available
                if (typeof QRious === 'undefined') {
                    console.error('QRious library not loaded');
                    alert('QR Code library not loaded. Please refresh the page and try again.');
                    return;
                }

                try {
                    // Create QR code using QRious
                    const canvas = document.createElement('canvas');
                    const qr = new QRious({
                        element: canvas,
                        value: data,
                        size: size,
                        level: errorCorrectionLevel,
                        foreground: '#000000',
                        background: '#FFFFFF'
                    });

                    // Display the QR code
                    $placeholder.hide();
                    $container.addClass('has-code');
                    $display.append(canvas);
                    $('.download-options').addClass('show');
                    
                    debugLog('QR code generated successfully');
                    saveState();
                    
                } catch (error) {
                    console.error('QR Code generation error:', error);
                    alert('Error generating QR code: ' + error.message);
                }
            }

            // --- Download Functions ---
            function downloadPNG() {
                if (!currentQRData) return;

                const canvas = $('#qr-code-display canvas')[0];
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `qrcode-${currentQRType}-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }

            function downloadSVG() {
                if (!currentQRData) return;

                try {
                    const size = parseInt($('#qr-size').val());
                    const errorCorrectionLevel = $('#error-correction').val();
                    
                    // Create a temporary QRious instance for SVG generation
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    const qr = new QRious({
                        element: svg,
                        value: currentQRData,
                        size: size,
                        level: errorCorrectionLevel,
                        foreground: '#000000',
                        background: '#FFFFFF'
                    });

                    // Get SVG content
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const blob = new Blob([svgData], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `qrcode-${currentQRType}-${Date.now()}.svg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('SVG generation error:', error);
                    alert('Error generating SVG. Downloading PNG instead.');
                    downloadPNG();
                }
            }

            // --- State Management ---
            function saveState() {
                const state = {
                    type: currentQRType,
                    size: $('#qr-size').val(),
                    errorCorrection: $('#error-correction').val()
                };

                // Save form data based on type
                const formData = {};
                $(`#form-${currentQRType} input, #form-${currentQRType} textarea, #form-${currentQRType} select`).each(function() {
                    formData[this.id] = $(this).val();
                });
                state.formData = formData;

                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // Restore QR type
                    if (state.type) {
                        switchQRType(state.type);
                    }
                    
                    // Restore options
                    if (state.size) $('#qr-size').val(state.size);
                    if (state.errorCorrection) $('#error-correction').val(state.errorCorrection);
                    
                    // Restore form data
                    if (state.formData) {
                        setTimeout(() => {
                            Object.keys(state.formData).forEach(id => {
                                $(`#${id}`).val(state.formData[id]);
                            });
                        }, 100);
                    }
                }
            }

            // --- QR Type Switching ---
            function switchQRType(type) {
                currentQRType = type;
                
                // Update active type card
                $('.qr-type-card').removeClass('active');
                $(`.qr-type-card[data-type="${type}"]`).addClass('active');
                
                // Update form
                $('#qr-form-container').html(qrForms[type]);
                
                // Clear QR code display
                resetQRCode();
                
                debugLog('Switched to QR type:', type);
            }

            function resetQRCode() {
                $('#qr-code-display').empty();
                $('#qr-code-container').removeClass('has-code');
                $('#qr-placeholder').show();
                $('.download-options').removeClass('show');
                currentQRData = '';
            }

            // --- Event Listeners ---
            $(document).on('click', '.qr-type-card', function() {
                const type = $(this).data('type');
                switchQRType(type);
                saveState();
            });

            $('#generate-btn').on('click', function() {
                debugLog('Generate button clicked');
                generateQRCode();
            });
            $('#download-png-btn').on('click', downloadPNG);
            $('#download-svg-btn').on('click', downloadSVG);

            $('#reset-btn').on('click', function() {
                // Reset form inputs
                $(`#form-${currentQRType} input, #form-${currentQRType} textarea, #form-${currentQRType} select`).val('');
                $(`#form-${currentQRType} input[type="checkbox"]`).prop('checked', false);
                
                // Reset options
                $('#qr-size').val('300');
                $('#error-correction').val('M');
                
                // Clear QR code
                resetQRCode();
                
                // Clear state
                localStorage.removeItem(STORAGE_KEY);
            });

            // Auto-save on input changes
            $(document).on('input change', '#qr-form-container input, #qr-form-container textarea, #qr-form-container select, #qr-size, #error-correction', function() {
                saveState();
            });

            // --- Initialize ---
            loadState();
            
            // Check if QRious library is loaded
            setTimeout(function() {
                if (typeof QRious === 'undefined') {
                    console.error('QRious library failed to load');
                    alert('QR Code library failed to load. Please check your internet connection and refresh the page.');
                } else {
                    debugLog('QRious library loaded successfully');
                }
            }, 1000);
        });
    </script>
</body>
</html>
