<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Compound Growth Calculator</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/trading/assets/css/styles.css">
    <!-- Global App Config -->
    <script src="/trading/assets/js/config.js"></script>
</head>

<body class="compound-growth-calculator-page d-flex flex-column vh-100">
    <div id="header-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <!-- Begin page content -->
    <main class="flex-grow-1">
        <div class="container py-4">
        <h1 class="mb-4 text-center">Compound Growth Calculator</h1>
        <p class="text-center text-muted mb-4">Enter your investment details below to calculate growth over time.</p>

        <div class="card">
            <div class="card-header">
                <h2>Investment Details</h2>
            </div>
            <div class="card-body">
                <div id="growthCalculatorForm">
                    <div class="row g-3">
                        <!-- Inputs -->
                        <div class="col-md-6">
                            <label for="initialInvestment" class="form-label">Initial Investment (<span id="investmentCurrencySymbol">$</span>)</label>
                            <input type="number" class="form-control" id="initialInvestment" value="1000" step="100" min="0"
                                required>
                            <input type="range" class="form-range mt-2" id="initialInvestmentSlider" min="0" max="50000" step="100">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Term</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="termValue" value="10" min="1" step="1" required>
                                <select id="termUnit" class="form-select" style="max-width: 120px;">
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                    <option value="months">Months</option>
                                    <option value="years" selected>Years</option>
                                </select>
                            </div>
                            <div id="termValidationError" class="form-text text-danger" style="display: none;"></div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label for="growthRate" class="form-label mb-0">Growth Rate (%)</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="allowNegativeGrowth">
                                    <label class="form-check-label small" for="allowNegativeGrowth">Allow Negative</label>
                                </div>
                            </div>
                            <input type="number" class="form-control" id="growthRate" value="5.25" step="0.1" required>
                            <input type="range" class="form-range mt-2" id="growthRateSlider" min="0" max="25" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Compounding Frequency</label>
                            <div class="input-group">
                                <span class="input-group-text">Every</span>
                                <input type="number" class="form-control" id="periodFrequency" value="1" min="1" step="1" required>
                                <select id="periodUnit" class="form-select" style="max-width: 120px;">
                                    <option value="days">Day(s)</option>
                                    <option value="weeks">Week(s)</option>
                                    <option value="months" selected>Month(s)</option>
                                    <option value="years">Year(s)</option>
                                </select>
                            </div>
                            <div class="form-text">
                                The frequency at which the growth is calculated and added to the principal.
                            </div>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="compoundGains" checked>
                                <label class="form-check-label" for="compoundGains">Compound Gains</label>
                                <div class="form-text">Gains are reinvested by default to compound your return. Uncheck to withdraw gains as income.</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h4>Outcome</h4>
                </div>
                <div class="card-body">
                    <div id="resultsSummary"></div>
                    <h6 id="toggleBreakdown" class="text-muted d-flex align-items-center mb-0 mt-3" style="cursor: pointer;" aria-expanded="false" aria-controls="breakdownContainer">
                        <span>Show Breakdown</span>
                        <span class="material-symbols-outlined collapse-chevron ms-2">chevron_forward</span>
                    </h6>
                    <div id="breakdownContainer" class="mt-3" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Period</th>
                                        <th scope="col">Start Balance</th>
                                        <th scope="col">Gain this Period</th>
                                        <th scope="col">End Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="breakdownTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toggles -->
        <div class="d-flex align-items-center gap-4 mt-4">
            <h6 class="text-muted d-flex align-items-center mb-0" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false" aria-controls="settingsCollapse">
                <span>Settings</span>
                <span class="material-symbols-outlined collapse-chevron ms-2">chevron_forward</span>
            </h6>
        </div>

        <!-- Settings Content -->
        <div class="collapse" id="settingsCollapse">
            <div class="p-3 border rounded mt-2">
                <div class="text-uppercase text-secondary small mb-3">Settings</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="currencySymbol" class="form-label">Currency Symbol</label>
                        <div class="input-group">
                            <select id="currencySymbol" class="form-select">
                                <option value="$" selected>$ (Dollar)</option>
                                <option value="£">£ (Pound)</option>
                                <option value="€">€ (Euro)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="text" class="form-control" id="customCurrencySymbol" placeholder="e.g. ¥" style="display: none;">
                        </div>
                        <div class="form-text">
                            Select a currency or choose 'Custom' to enter your own.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>


    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <!-- Shared Header Script -->
    <script src="/trading/assets/js/header.js"></script>

    <script>
        $(document).ready(function () {
            // Load shared components
            $("#header-placeholder").load("/trading/assets/includes/_header.html", function() {
                if (typeof initializeHeader === 'function') {
                    initializeHeader();
                }
            });
            $("#navbar-placeholder").load("/trading/assets/includes/_navbar.html");
            $("#footer-placeholder").load("/trading/assets/includes/_footer.html");

            // --- Persist Form Inputs using localStorage ---
            const formInputIds = [
                '#initialInvestment',
                '#termValue',
                '#termUnit',
                '#growthRate',
                '#allowNegativeGrowth',
                '#compoundGains',
                '#periodFrequency',
                '#periodUnit',
                '#currencySymbol',
                '#customCurrencySymbol'
            ];
            const storageKey = 'compoundGrowthCalculatorInputs';

            // Function to save form data to localStorage
            function saveFormValues() {
                const values = {};
                formInputIds.forEach(selector => {
                    const $el = $(selector);
                    const id = $el.attr('id');
                    if ($el.is(':checkbox')) {
                        values[id] = $el.is(':checked');
                    } else {
                        values[id] = $el.val();
                    }
                });
                values.isSettingsExpanded = $('#settingsCollapse').hasClass('show');
                localStorage.setItem(storageKey, JSON.stringify(values));
            }

            // Function to load form data from localStorage
            function loadFormValues() {
                const savedValues = localStorage.getItem(storageKey);
                if (savedValues) {
                    const values = JSON.parse(savedValues);
                    formInputIds.forEach(selector => {
                        const $el = $(selector);
                        const id = $el.attr('id');
                        if (values[id] !== undefined) {
                            if ($el.is(':checkbox')) {
                                $el.prop('checked', values[id]);
                            } else {
                                $el.val(values[id]);
                            }
                        }
                    });
            // Load collapse state
            if (values.isSettingsExpanded) {
                const settingsCollapse = new bootstrap.Collapse('#settingsCollapse', { toggle: false });
                settingsCollapse.show();
            }
                }
            }

            // --- Currency Helper Functions ---
            function updateCurrencyUI() {
                const currencySelect = $('#currencySymbol');
                const customInput = $('#customCurrencySymbol');
                const selectedSymbol = currencySelect.val();

                if (selectedSymbol === 'custom') {
                    customInput.show();
                    $('#investmentCurrencySymbol').text(customInput.val() || '$');
                } else {
                    customInput.hide();
                    $('#investmentCurrencySymbol').text(selectedSymbol);
                }
            }

            function getCurrentCurrencySymbol() {
                const selected = $('#currencySymbol').val();
                if (selected === 'custom') {
                    return $('#customCurrencySymbol').val() || '$'; // Default to $ if custom is empty
                }
                return selected;
            }

            // --- Slider Controls ---
            const $initialInvestment = $('#initialInvestment');
            const $initialInvestmentSlider = $('#initialInvestmentSlider');
            const $growthRate = $('#growthRate');
            const $growthRateSlider = $('#growthRateSlider');
            const $allowNegativeGrowth = $('#allowNegativeGrowth');

            // Syncs slider positions with input values and dynamically adjusts slider max range if needed.
            function syncSliders() {
                const investmentVal = parseFloat($initialInvestment.val()) || 0;
                const currentInvestmentMax = parseFloat($initialInvestmentSlider.attr('max'));
                if (investmentVal > currentInvestmentMax) {
                    $initialInvestmentSlider.attr('max', investmentVal * 1.5);
                }
                $initialInvestmentSlider.val(investmentVal);

                const rateVal = parseFloat($growthRate.val()) || 0;
                const currentRateMax = parseFloat($growthRateSlider.attr('max'));
                // The min attribute is now controlled by the 'allowNegativeGrowth' checkbox logic.
                // We only adjust the max here if needed.
                if (rateVal > currentRateMax) {
                    $growthRateSlider.attr('max', rateVal * 1.5);
                }
                $growthRateSlider.val(rateVal);
            }

            // Event: When a slider is moved, update the corresponding text input and trigger its 'input' event.
            $initialInvestmentSlider.on('input', function() {
                $initialInvestment.val($(this).val()).trigger('input');
            });
            $growthRateSlider.on('input', function() {
                $growthRate.val($(this).val()).trigger('input');
            });

            // Event: When a text input changes, sync its corresponding slider.
            $initialInvestment.on('input', syncSliders);
            $growthRate.on('input', syncSliders);

            // --- Growth Rate Negative Toggle ---
            function handleNegativeGrowthToggle() {
                const allowNegative = $allowNegativeGrowth.is(':checked');
                const newMin = allowNegative ? -10 : 0;

                $growthRate.attr('min', newMin);
                $growthRateSlider.attr('min', newMin);

                // If negative values are disallowed, clamp the current value to 0 if it's negative.
                if (!allowNegative && parseFloat($growthRate.val()) < 0) {
                    $growthRate.val(0).trigger('input'); // trigger input to update slider and recalculate
                }
            }

            $allowNegativeGrowth.on('change', handleNegativeGrowthToggle);

            // --- Calculation Logic ---
            function calculateAndDisplayResults() {
                $('#termValidationError').hide(); // Clear previous validation errors
                updateCurrencyUI(); // Ensure currency UI is up-to-date
                const compoundGains = $('#compoundGains').is(':checked');

                // 1. Get and parse inputs
                const initialInvestment = parseFloat($('#initialInvestment').val());
                const growthRate = parseFloat($('#growthRate').val()) / 100; // Convert percentage to decimal
                const periodFrequency = parseInt($('#periodFrequency').val());
                const periodUnit = $('#periodUnit').val();
                const termValue = parseInt($('#termValue').val());
                const termUnit = $('#termUnit').val();

                // Basic validation
                if (isNaN(initialInvestment) || isNaN(growthRate) || isNaN(termValue) || isNaN(periodFrequency) ||
                    initialInvestment < 0 || termValue <= 0 || periodFrequency <= 0) {
                    $('#results').hide(); // Hide results if inputs are invalid
                    return;
                }

                // 2. Normalize units to a common base (days) for comparison
                const getDaysInUnit = (unit) => {
                    switch (unit) {
                        case 'days': return 1;
                        case 'weeks': return 7;
                        case 'months': return 365.25 / 12; // Average month length
                        case 'years': return 365.25; // Account for leap years
                        default: return 0;
                    }
                };

                const daysPerPeriod = getDaysInUnit(periodUnit) * periodFrequency;
                const totalTermInDays = termValue * getDaysInUnit(termUnit);

                // The investment term must be at least as long as one compounding period.
                if (totalTermInDays < daysPerPeriod) {
                    $('#results').hide();
                    $('#termValidationError').text('Term must be at least one compounding period.').show();
                    return;
                }

                // 3. Calculate the total number of compounding periods
                const numberOfPeriods = totalTermInDays > 0 ? Math.floor(totalTermInDays / daysPerPeriod) : 0;

                // 4. Perform iterative calculation
                let currentValue = initialInvestment;
                const breakdownData = [];
                let totalWithdrawnIncome = 0;


                // Prepare unit for display, e.g., "Month" for singular or "Months" for plural.
                const singularUnit = periodUnit.slice(0, -1);
                const displayUnitBase = periodFrequency === 1 ? singularUnit : periodUnit;
                const displayUnit = displayUnitBase.charAt(0).toUpperCase() + displayUnitBase.slice(1);

                for (let i = 1; i <= numberOfPeriods; i++) {
                    const startOfPeriodValue = currentValue;
                    const calculationPrincipal = compoundGains ? startOfPeriodValue : initialInvestment;
                    const gainForPeriod = calculationPrincipal * growthRate;

                    if (compoundGains) {
                        currentValue += gainForPeriod;
                    } else {
                        // In simple interest mode, the principal never changes.
                        totalWithdrawnIncome += gainForPeriod;
                    }

                    let descriptiveLabel;
                    if (periodFrequency === 1) {
                        descriptiveLabel = `${displayUnit} ${i}`;
                    } else {
                        const startRange = (i - 1) * periodFrequency + 1;
                        const endRange = i * periodFrequency;
                        descriptiveLabel = `${displayUnit} ${startRange}-${endRange}`;
                    }

                    breakdownData.push({
                        period: `${i}. ${descriptiveLabel}`,
                        start: startOfPeriodValue,
                        gain: gainForPeriod,
                        end: compoundGains ? currentValue : startOfPeriodValue
                    });
                }

                const totalGain = compoundGains ? (currentValue - initialInvestment) : totalWithdrawnIncome;

                // 5. Display results
                const currencySymbol = getCurrentCurrencySymbol();
                const numberFormatter = new Intl.NumberFormat('en-US', {
                    style: 'decimal',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });

                const percentageGain = initialInvestment > 0 ? (totalGain / initialInvestment) * 100 : 0;

                let resultsHtml;
                if (compoundGains) {
                    resultsHtml = `
                        <p class="card-text mb-1">Initial Value: <span class="fw-bold">${currencySymbol}${numberFormatter.format(initialInvestment)}</span></p>
                        <p class="card-text mb-1">Final Value: <span class="fw-bold">${currencySymbol}${numberFormatter.format(currentValue)}</span></p>
                        <p class="card-text mb-0">Total Gain: <span class="fw-bold ${totalGain >= 0 ? 'text-success' : 'text-danger'}">${currencySymbol}${numberFormatter.format(totalGain)} (${totalGain >= 0 ? '+' : ''}${numberFormatter.format(percentageGain)}%)</span></p>
                    `;
                } else {
                    const daysInMonth = getDaysInUnit('months');
                    const interestPerPeriod = initialInvestment * growthRate;
                    const interestPerDay = daysPerPeriod > 0 ? interestPerPeriod / daysPerPeriod : 0;
                    const monthlyInterest = interestPerDay * daysInMonth;

                    resultsHtml = `
                        <p class="card-text mb-1">Principal Value: <span class="fw-bold">${currencySymbol}${numberFormatter.format(initialInvestment)}</span> <span class="text-muted">(remains constant)</span></p>
                        <p class="card-text mb-1">Monthly interest available to withdraw: <span class="fw-bold ${monthlyInterest >= 0 ? 'text-success' : 'text-danger'}">${currencySymbol}${numberFormatter.format(monthlyInterest)}</span></p>
                        <p class="card-text mb-0">Total Income Withdrawn: <span class="fw-bold ${totalGain >= 0 ? 'text-success' : 'text-danger'}">${currencySymbol}${numberFormatter.format(totalWithdrawnIncome)}</span></p>
                    `;
                }

                $('#resultsSummary').html(resultsHtml);

                // Populate breakdown table
                const tableBody = $('#breakdownTableBody');
                const tableHeaders = $('#results thead tr');
                tableBody.empty(); // Clear previous results

                if (compoundGains) {
                    tableHeaders.html(`
                        <th scope="col">Period</th>
                        <th scope="col">Start Balance</th>
                        <th scope="col">Gain this Period</th>
                        <th scope="col">End Balance</th>
                    `);
                } else {
                    tableHeaders.html(`
                        <th scope="col">Period</th>
                        <th scope="col">Principal</th>
                        <th scope="col">Income this Period</th>
                        <th scope="col">End Principal</th>
                    `);
                }

                breakdownData.forEach(data => {
                    const row = `<tr>
                        <td>${data.period}</td>
                        <td>${currencySymbol}${numberFormatter.format(data.start)}</td>
                        <td class="${data.gain >= 0 ? 'text-success' : 'text-danger'}">${currencySymbol}${numberFormatter.format(data.gain)}</td>
                        <td>${currencySymbol}${numberFormatter.format(data.end)}</td>
                    </tr>`;
                    tableBody.append(row);
                });

                // Show results and reset breakdown view
                $('#results').show();
            }

            // --- Event Handlers & Initial Load ---

            // Load saved values from storage when the page loads
            loadFormValues();

            // Set initial state for negative growth based on loaded value
            handleNegativeGrowthToggle();

            // Sync sliders to the loaded or default values
            syncSliders();

            // Run the calculation once on page load with the stored/default values
            calculateAndDisplayResults();

            // Add listeners to save and recalculate whenever an input changes
            $(formInputIds.join(', ')).on('input change', function() {
                updateCurrencyUI();
                saveFormValues();
                calculateAndDisplayResults();
            });

            // Also save state when collapse is toggled
            $('#settingsCollapse').on('shown.bs.collapse hidden.bs.collapse', saveFormValues);

            // --- Toggle Breakdown Table Visibility ---
            $('#toggleBreakdown').on('click', function () {
                const $toggle = $(this);
                const $container = $('#breakdownContainer');
                const $textSpan = $toggle.find('span:first');
                const isVisible = $container.is(':visible');

                // Toggle aria-expanded attribute to control chevron rotation via CSS
                $toggle.attr('aria-expanded', !isVisible);

                // Update the text to reflect the new state
                $textSpan.text(isVisible ? 'Show Breakdown' : 'Hide Breakdown');

                // Animate the toggle
                $container.slideToggle();
            });
        });
    </script>

</body>

</html>