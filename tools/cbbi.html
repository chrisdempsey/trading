<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>CBBI Bitcoin Index</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/trading/assets/css/styles.css">
    <!-- Global App Config -->
    <script src="/trading/assets/js/config.js"></script>
</head>
    <style>
        .confidence-score-wrapper {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: background-color 0.5s ease;
            margin: 0 auto;
        }

        .confidence-score {
            font-size: 4rem;
            font-weight: bold;
            line-height: 1;
        }

        .confidence-label {
            font-size: 1rem;
            font-weight: 300;
        }

        .metric-card {
            transition: all 0.3s ease;
            border-left-width: 5px;
        }

        .metric-card.disabled {
            opacity: 0.5;
            background-color: #f8f9fa;
        }

        .dark-mode .metric-card.disabled {
            /* Use a dark background for disabled cards in dark mode */
            background-color: #212529; /* Bootstrap's 'gray-900' */
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .metric-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>

<body class="d-flex flex-column vh-100">
    <div id="header-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="container mt-4 flex-grow-1">
        <div class="row">
            <div class="col-12 text-center">
                <h1>CBBI Bitcoin Index</h1>
                <p class="lead">A recreation of the <a href="https://colintalkscrypto.com/cbbi/" target="_blank"
                        rel="noopener noreferrer">ColinTalksCrypto Bitcoin Bull Run Index</a>.</p>
            </div>
        </div>

        <div class="row my-4">
            <div class="col-12 text-center">
                <div id="confidence-score-wrapper" class="confidence-score-wrapper bg-secondary">
                    <div id="confidence-score" class="confidence-score">...</div>
                    <div class="confidence-label">Confidence</div>
                </div>
                <div id="last-updated" class="text-muted mt-2"></div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div id="metrics-wrapper" class="row g-3">
                    <!-- Metrics will be dynamically inserted here -->
                </div>
                <div id="loading-message" class="text-center my-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Fetching latest CBBI data...</p>
                </div>
                <div id="error-message" class="alert alert-danger text-center my-5" style="display: none;"></div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Shared Header Script -->
    <script src="/trading/assets/js/header.js"></script>

    <script>
        // Load shared components
        $(function() {
            $("#header-placeholder").load("/trading/assets/includes/_header.html", function() {
                if (typeof initializeHeader === 'function') {
                    initializeHeader();
                }
            });
            $("#navbar-placeholder").load("/trading/assets/includes/_navbar.html");
            $("#footer-placeholder").load("/trading/assets/includes/_footer.html");
        });
    </script>

    <script>
        // CBBI Page Logic
        $(document).ready(function() {
            const API_URL = 'https://colintalkscrypto.com/cbbi/data/latest.json';
            let cbbiData = null;

            // Map API keys to human-readable names and original data-include-index-name
            const metricDetails = {
                pi_cycle_top: { name: "Pi Cycle Top Indicator", indexName: "PiCycle" },
                ruh: { name: "Realised UTXO HODL Waves", indexName: "RUH" },
                puell_multiple: { name: "Puell Multiple", indexName: "Puell" },
                mvrv: { name: "MVRV Z-Score", indexName: "MVRV" },
                trolololo: { name: "Trolololo Trend Line", indexName: "Trolololo" },
                two_year_ma: { name: "2-Year MA Multiplier", indexName: "2YMA" },
                reserve_risk: { name: "Reserve Risk", indexName: "Reserve_Risk" },
                rhodl: { name: "RHODL Ratio", indexName: "RHODL" },
                cvdd: { name: "CVDD", indexName: "CVDD" }
            };

            /**
             * Returns a color from red to green based on a value from 0 to 100.
             * @param {number} value The value (0-100).
             * @returns {string} A HSL color string.
             */
            function getColorForValue(value) {
                if (value < 0) value = 0;
                if (value > 100) value = 100;
                // Hue goes from 0 (red) to 120 (green)
                const hue = (value * 1.2).toString(10);
                return `hsl(${hue}, 100%, 45%)`;
            }

            /**
             * Calculates the average score from active metrics and updates the UI.
             */
            function calculateAndDisplayScore() {
                if (!cbbiData) return;

                const components = cbbiData.components;
                const activeValues = [];

                $('#metrics-wrapper .form-check-input').each(function() {
                    const metricKey = $(this).data('metric-key');
                    const card = $(this).closest('.metric-card');

                    if (this.checked) {
                        if (components[metricKey] !== undefined) {
                            activeValues.push(components[metricKey]);
                        }
                        card.removeClass('disabled');
                    } else {
                        card.addClass('disabled');
                    }
                });

                let finalScore = 0;
                if (activeValues.length > 0) {
                    // Sort the array to find the median
                    activeValues.sort((a, b) => a - b);
                    const mid = Math.floor(activeValues.length / 2);
                    
                    // Handle even or odd number of metrics
                    finalScore = activeValues.length % 2 !== 0 ? activeValues[mid] : (activeValues[mid - 1] + activeValues[mid]) / 2;
                }

                const averageScore = Math.round(finalScore);

                // Update main confidence score display
                const scoreWrapper = $('#confidence-score-wrapper');
                const scoreEl = $('#confidence-score');

                scoreEl.text(averageScore);
                scoreWrapper.css('background-color', getColorForValue(averageScore));
            }

            /**
             * Renders the individual metric cards on the page.
             */
            function renderMetrics() {
                const components = cbbiData.components;
                const metricsWrapper = $('#metrics-wrapper');
                metricsWrapper.empty();

                for (const key in metricDetails) {
                    if (Object.hasOwnProperty.call(metricDetails, key) && components[key] !== undefined) {
                        const value = components[key];
                        const detail = metricDetails[key];
                        const color = getColorForValue(value);

                        const metricHtml = `
                            <div class="col-md-6">
                                <div class="card metric-card" style="border-left-color: ${color};">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1">
                                                    <span class="metric-indicator" style="background-color: ${color};"></span>
                                                    ${detail.name}
                                                </h6>
                                                <small class="text-muted" data-include-index-name="${detail.indexName}"></small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" data-metric-key="${key}" checked>
                                            </div>
                                        </div>
                                        <p class="card-text metric-value text-end mt-2">${value}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        metricsWrapper.append(metricHtml);
                    }
                }

                // Add event listeners to the new toggles
                $('#metrics-wrapper .form-check-input').on('change', calculateAndDisplayScore);
            }

            /**
             * Fetches data from the API and initializes the page.
             */
            async function fetchData() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    const rawJson = await response.json();

                    // The API returns a large object with timestamps as keys for each metric.
                    // We need to find the latest timestamp and build a data object for that day.
                    const timestamps = Object.keys(rawJson.Price || {});
                    if (timestamps.length === 0) {
                        throw new Error('No data available in the API response.');
                    }
                    
                    // Find the most recent timestamp (timestamps are in seconds)
                    const latestTimestamp = Math.max(...timestamps.map(Number));

                    // Re-structure the data to match what the rest of the script expects
                    const components = {};
                    for (const internalKey in metricDetails) {
                        const detail = metricDetails[internalKey];
                        const apiKey = detail.indexName; // e.g., "PiCycle"
                        const metricData = rawJson[apiKey];
                        
                        if (metricData) {
                            // Find the most recent timestamp for this specific metric that is on or before the global latestTimestamp.
                            // This handles cases where some data series (like NUPL) lag by a day.
                            const metricTimestamps = Object.keys(metricData).map(Number);
                            const availableTimestamps = metricTimestamps.filter(ts => ts <= latestTimestamp);
                            
                            if (availableTimestamps.length > 0) {
                                const mostRecentMetricTimestamp = Math.max(...availableTimestamps);
                                const value = parseFloat(metricData[mostRecentMetricTimestamp]);
                                if (!isNaN(value)) {
                                    components[internalKey] = value;
                                }
                            }
                        }
                    }

                    if (Object.keys(components).length === 0) {
                        throw new Error('Failed to parse component data from the API response.');
                    }

                    // This is the data structure the rest of the script uses
                    cbbiData = {
                        date: new Date(latestTimestamp * 1000), // Keep as Date object for formatting
                        price: rawJson.Price[latestTimestamp],
                        components: components
                    };

                    $('#loading-message').hide();

                    // Update last updated timestamp
                    const formattedDate = cbbiData.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    $('#last-updated').text(`Last Updated: ${formattedDate} | Price: $${cbbiData.price.toLocaleString()}`);

                    renderMetrics();
                    calculateAndDisplayScore();

                } catch (error) {
                    console.error('Failed to fetch CBBI data:', error);
                    $('#loading-message').hide();
                    $('#error-message').text(`Failed to load data. Please try again later. Error: ${error.message}`).show();
                }
            }

            // Initial load
            fetchData();
        });
    </script>

</body>

</html>